// Em boleto/ProcessadorLinhaDigitavel.java

package boleto;

import boleto.ValidadorLinhaDigitavel;
import verificacao.ConsultaCNPJ;
import verificacao.ConsultaBanco;
import usuario.Boleto;
import java.math.BigDecimal;
import java.util.Scanner;
import java.io.IOException;
import java.sql.SQLException;
import java.time.LocalDate; // Importar LocalDate
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter; // Importar DateTimeFormatter
import java.time.format.DateTimeParseException; // Importar DateTimeParseException
import bancodedados.RepositorioLinhaDigitavel; // Novo reposit√≥rio
import bancodedados.RepositorioUsuario; // Assumindo que a classe RepositorioUsuario existe
import usuario.Usuario; 

import bancodedados.ConexaoBD; // Importar ConexaoBD
import java.sql.Connection; // Importar Connection para o m√©todo inserirOuAtualizarCnpjEmitente
import java.sql.Date; // Importar Date
import java.sql.PreparedStatement; // Importar PreparedStatement
import java.sql.ResultSet; // Importar ResultSet



public class ProcessadorLinhaDigitavel {

    private Scanner scanner;
    private RepositorioLinhaDigitavel repositorioLinhaDigitavel; // Novo reposit√≥rio
    private RepositorioUsuario repositorioUsuario; // Para criar/obter usu√°rio an√¥nimo

    public ProcessadorLinhaDigitavel(Scanner scanner) {
        this.scanner = scanner;
        this.repositorioLinhaDigitavel = new RepositorioLinhaDigitavel();
        this.repositorioUsuario = new RepositorioUsuario();
    }

   public void processar() throws SQLException {
        System.out.println("\n--- Processamento de Boleto por Linha Digital ---");
        System.out.println("Por favor, digite a linha digital (c√≥digo de barras, com ou sem pontos/espa√ßos):");
        
        String linhaDigitalInput = scanner.nextLine();
        String linhaDigital = linhaDigitalInput.trim().replaceAll("[^0-9]", "");

        if (linhaDigital.length() != 47) {
            System.err.println("‚ùå Erro: A linha digital deve conter 47 d√≠gitos num√©ricos. Voc√™ digitou " + linhaDigitalInput.length() + " caracteres (incluindo pontos/espa√ßos) que resultaram em " + linhaDigital.length() + " d√≠gitos num√©ricos.");
            System.err.println("Por favor, verifique a entrada. Ex: 00190000090362072700200439729179799850000222900");
            return;
        }

        System.out.println("‚úÖ Linha digital capturada e limpa: " + linhaDigital);

        Boleto boleto = new Boleto();
        boleto.setCodigoBarras(linhaDigital);
        boleto.setDataExtracao(LocalDateTime.now()); // Define a data de extra√ß√£o para agora

        // Valida√ß√£o da estrutura da linha digital
        System.out.println("\n--- Realizando valida√ß√£o detalhada da Linha Digital ---");
        boolean linhaDigitalEstruturaValida = ValidadorLinhaDigitavel.validar(linhaDigital);
        
        if (!linhaDigitalEstruturaValida) {
            System.out.println("‚ùå Valida√ß√£o de estrutura da Linha Digital FALHOU.");
            boleto.setStatusValidacao("ERRO_ESTRUTURA_LD"); 
            System.out.println("‚ö†Ô∏è No entanto, continuaremos com outras verifica√ß√µes.");
        } else {
            System.out.println("‚úÖ Valida√ß√£o de estrutura da Linha Digital OK.");
            boleto.setStatusValidacao("VALIDO_ESTRUTURA_LD");
        }

        // Solicita a data de vencimento
        LocalDate vencimento = null;
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy");
        while (vencimento == null) {
            System.out.println("\nPor favor, digite a data de vencimento do boleto (DD/MM/AAAA):");
            String dataInput = scanner.nextLine().trim();
            try {
                vencimento = LocalDate.parse(dataInput, formatter);
                boleto.setVencimento(vencimento);
            } catch (DateTimeParseException e) {
                System.err.println("‚ùå Formato de data inv√°lido. Use o formato DD/MM/AAAA (ex: 25/12/2023).");
            }
        }

        System.out.println("\nEste boleto possui algum desconto? (sim/nao)");
        String temDescontoStr = scanner.nextLine().trim().toLowerCase();
        boolean temDesconto = "sim".equals(temDescontoStr);

        BigDecimal valorInformadoPeloUsuario = null;
        if (temDesconto) {
            System.out.println("Por favor, digite o valor *original* do boleto (sem descontos, formato 00.00):");
            while (valorInformadoPeloUsuario == null) {
                try {
                    String valorInput = scanner.nextLine().replace(",", ".");
                    valorInformadoPeloUsuario = new BigDecimal(valorInput);
                } catch (NumberFormatException e) {
                    System.err.println("‚ùå Formato de valor inv√°lido. Digite novamente o valor original (ex: 123.45):");
                }
            }
        } else {
            System.out.println("Por favor, digite o valor do pagamento do boleto (formato 00.00):");
            while (valorInformadoPeloUsuario == null) {
                try {
                    String valorInput = scanner.nextLine().replace(",", ".");
                    valorInformadoPeloUsuario = new BigDecimal(valorInput);
                } catch (NumberFormatException e) {
                    System.err.println("‚ùå Formato de valor inv√°lido. Digite novamente o valor (ex: 123.45):");
                }
            }
        }
        boleto.setValor(valorInformadoPeloUsuario);

        BigDecimal valorDoCodigoBarras = null;
        // Tenta extrair o valor do c√≥digo de barras da linha digital
        try {
             String valorStr = linhaDigital.substring(linhaDigital.length() - 10);
             String valorFormatado = valorStr.substring(0, 8) + "." + valorStr.substring(8, 10);
             valorDoCodigoBarras = new BigDecimal(valorFormatado);
        } catch (NumberFormatException | StringIndexOutOfBoundsException e) {
            System.err.println("Erro ao extrair valor do c√≥digo de barras da linha digital: " + e.getMessage());
            // Se n√£o conseguir extrair, mant√©m como null ou 0 para a compara√ß√£o
            valorDoCodigoBarras = BigDecimal.ZERO; 
        }


        System.out.println("\n--- Verifica√ß√£o do Valor Final ---");
        System.out.println("Valor informado pelo usu√°rio (sem desconto): " + valorInformadoPeloUsuario);
        System.out.println("Valor extra√≠do da linha digital: " + valorDoCodigoBarras);

        if (valorInformadoPeloUsuario.compareTo(valorDoCodigoBarras) == 0) {
            System.out.println("‚úÖ O valor informado corresponde ao valor na linha digital. Verifica√ß√£o de valor OK.");
        } else {
            System.out.println("‚ö†Ô∏è ATEN√á√ÉO: O valor informado N√ÉO corresponde ao valor na linha digital. Isso pode indicar um problema.");
        }

        System.out.println("\n--- Verifica√ß√£o do CNPJ ---");
        System.out.println("Por favor, informe o CNPJ do benefici√°rio (somente n√∫meros):");
        String cnpjInformado = scanner.nextLine().trim().replaceAll("[^0-9]", "");
        boleto.setCnpjEmitente(cnpjInformado);

        int verificacoesComFalha = 0; // Contador de falhas para o status geral

        if (cnpjInformado.length() == 14) {
            System.out.println("üåê Consultando CNPJ na BrasilAPI...");
            ConsultaCNPJ consultaCnpj = new ConsultaCNPJ(boleto); // Passa o objeto boleto para ser preenchido
            String statusConsultaCnpj = consultaCnpj.validarDadosComApi();

            System.out.println("‚ÑπÔ∏è Status da valida√ß√£o do CNPJ com a API: " + statusConsultaCnpj);

            // Chamar o m√©todo para inserir/atualizar CNPJ na tabela CNPJ_Emitente
            inserirOuAtualizarCnpjEmitente(cnpjInformado, boleto.getRazaoSocialApi());


            System.out.println("\n--- Dados do CNPJ " + cnpjInformado + " Retornados pela BrasilAPI ---");
            System.out.println("üìù Raz√£o Social: " + (boleto.getRazaoSocialApi() != null ? boleto.getRazaoSocialApi() : "N√£o dispon√≠vel"));
            System.out.println("‚ú® Nome Fantasia: " + (boleto.getNomeFantasiaApi() != null ? boleto.getNomeFantasiaApi() : "N√£o dispon√≠vel"));
            System.out.println("--------------------------------------------------");

            // L√≥gica de compara√ß√£o de nomes (similar ao ProcessadorBoleto)
            String nomePdf = boleto.getNomeBeneficiario(); // Manter√° o valor original ou ser√° nulo/vazio
            String razaoApi = boleto.getRazaoSocialApi();

            if (nomePdf != null && !nomePdf.isEmpty() && razaoApi != null && !razaoApi.isEmpty()) {
                String nomePdfLimpo = nomePdf.toLowerCase().replaceAll("\\s+", "");
                String razaoApiLimpa = razaoApi.toLowerCase().replaceAll("\\s+", "");

                if (!nomePdfLimpo.equals(razaoApiLimpa) && !nomePdfLimpo.contains(razaoApiLimpa)
                        && !razaoApiLimpa.contains(nomePdfLimpo)) {
                    System.out.println("üö® **ALERTA DE FRAUDE POTENCIAL:** Nome do benefici√°rio informado ('"
                            + boleto.getNomeBeneficiario() +
                            "') DIVERGE da Raz√£o Social da API ('" + boleto.getRazaoSocialApi()
                            + "') para este CNPJ.");
                    boleto.setStatusValidacao("ALERTA_FRAUDE_NOME_CNPJ_DIVERGENTE");
                    verificacoesComFalha++;
                } else {
                    System.out.println("‚úÖ O nome do benefici√°rio informado ('" + boleto.getNomeBeneficiario() +
                            "') BATE com a Raz√£o Social da API ('" + boleto.getRazaoSocialApi() + "').");
                }
            } else {
                System.out.println(
                        "‚ÑπÔ∏è N√£o foi poss√≠vel comparar o nome do benefici√°rio com a Raz√£o Social da API (dados ausentes ou n√£o dispon√≠veis).");
            }


            System.out.println("\nAs informa√ß√µes do CNPJ acima est√£o corretas? (sim/nao)");
            String confirmacaoDadosCnpj = scanner.nextLine().trim().toLowerCase();

            if ("sim".equals(confirmacaoDadosCnpj)) {
                System.out.println("üëç Confirma√ß√£o dos dados do CNPJ registrada.");
                boleto.setInformacoesConfirmadasPeloUsuario(true);
                if (statusConsultaCnpj.equals("VALIDO_API")) {
                    // Mant√©m status de fraude se j√° foi detectado, sen√£o atualiza
                    if (!"ALERTA_FRAUDE_NOME_CNPJ_DIVERGENTE".equals(boleto.getStatusValidacao())) {
                       boleto.setStatusValidacao("VALIDO_CNPJ_API_E_USUARIO");
                    }
                } else {
                     if (!"ALERTA_FRAUDE_NOME_CNPJ_DIVERGENTE".equals(boleto.getStatusValidacao())) {
                        boleto.setStatusValidacao("CNPJ_CONFIRMADO_USUARIO_COM_ALERTA");
                    }
                }
            } else {
                System.out.println("üö´ Voc√™ indicou que os dados do CNPJ n√£o est√£o corretos. Marcarei como 'CNPJ_NAO_CONFIRMADO_USUARIO'.");
                boleto.setInformacoesConfirmadasPeloUsuario(false);
                boleto.setStatusValidacao("CNPJ_NAO_CONFIRMADO_USUARIO");
                verificacoesComFalha++;
            }
        } else {
            System.out.println("‚ö†Ô∏è CNPJ inv√°lido. A consulta n√£o ser√° realizada. Marcarei como 'CNPJ_INVALIDO_FORMATO'.");
            boleto.setStatusValidacao("CNPJ_INVALIDO_FORMATO");
            boleto.setInformacoesConfirmadasPeloUsuario(false);
            verificacoesComFalha++;
        }

        // --- IN√çCIO DA L√ìGICA PARA CONFIRMA√á√ÉO DETALHADA DO BANCO ---
        System.out.println("\n--- Verifica√ß√£o do Banco Emissor ---");
        String codigoBanco = linhaDigital.substring(0, 3);
        boleto.setBancoEmissor(codigoBanco); // Define o c√≥digo do banco extra√≠do da linha digit√°vel

        System.out.println("üè¶ C√≥digo do banco extra√≠do da linha digital: " + codigoBanco);

        ConsultaBanco consultaBanco = new ConsultaBanco(boleto);
        String statusConsultaBanco = consultaBanco.validarBancoComApi(); // Isso preenche os campos do boleto
        boleto.setStatusValidacaoBanco(statusConsultaBanco); // Define o status de valida√ß√£o do banco no boleto

        System.out.println("‚ÑπÔ∏è Status da valida√ß√£o do banco com a API: " + statusConsultaBanco);

        // Exibir os dados puxados da API
        System.out.println("\n--- Dados do Banco " + codigoBanco + " Retornados pela BrasilAPI ---");
        System.out.println("üè¶ C√≥digo do Banco (API): " + (boleto.getBancoEmissor() != null ? boleto.getBancoEmissor() : "N√£o dispon√≠vel"));
        System.out.println("üìù Nome do Banco (API): " + (boleto.getNomeBancoApi() != null ? boleto.getNomeBancoApi() : "N√£o dispon√≠vel"));
        System.out.println("‚ú® Nome Completo do Banco (API): " + (boleto.getNomeCompletoBancoApi() != null ? boleto.getNomeCompletoBancoApi() : "N√£o dispon√≠vel"));
        System.out.println("üî¢ ISPB (API): " + (boleto.getIspbBancoApi() != null ? boleto.getIspbBancoApi() : "N√£o dispon√≠vel"));
        System.out.println("--------------------------------------------------");

        // Pergunta de confirma√ß√£o ao usu√°rio
        System.out.println("\nAs informa√ß√µes do banco acima est√£o corretas? (sim/nao)");
        String confirmacaoDadosBanco = scanner.nextLine().trim().toLowerCase();

        if ("sim".equals(confirmacaoDadosBanco)) {
            System.out.println("üëç Confirma√ß√£o dos dados do banco registrada.");
            if (statusConsultaBanco.equals("VALIDO_API")) {
                boleto.setStatusValidacaoBanco("VALIDO_BANCO_API_E_USUARIO");
            } else {
                boleto.setStatusValidacaoBanco("BANCO_CONFIRMADO_USUARIO_COM_ALERTA"); 
            }
        } else {
            System.out.println("üö´ Voc√™ indicou que os dados do banco n√£o est√£o corretos. Marcarei como 'BANCO_NAO_CONFIRMADO_USUARIO'.");
            boleto.setStatusValidacaoBanco("BANCO_NAO_CONFIRMADO_USUARIO");
            verificacoesComFalha++;
        }
        // --- FIM DA L√ìGICA PARA CONFIRMA√á√ÉO DETALHADA DO BANCO ---

        // Atualiza o status geral do boleto com base nas falhas de verifica√ß√£o
        if (verificacoesComFalha > 0 && !"ALERTA_FRAUDE_NOME_CNPJ_DIVERGENTE".equals(boleto.getStatusValidacao())) {
            boleto.setStatusValidacao("ALERTA_GERAL_NAO_CONFORMIDADE");
            boleto.setDenunciado(true); // Marca como denunciado automaticamente se houver falhas
        } else if (verificacoesComFalha == 0 && !"ALERTA_FRAUDE_NOME_CNPJ_DIVERGENTE".equals(boleto.getStatusValidacao()) && !"ERRO_ESTRUTURA_LD".equals(boleto.getStatusValidacao())) {
            // Se n√£o houve falhas e n√£o h√° alerta de fraude por nome/CNPJ ou erro de estrutura LD
            boleto.setStatusValidacao("VALIDO_COMPLETO");
        }


        // Associa o boleto a um usu√°rio an√¥nimo antes de salvar
        Usuario usuarioAnonimo = repositorioUsuario.criarUsuarioAnonimo();
        if (usuarioAnonimo == null || usuarioAnonimo.getId() == 0) {
            System.err.println("‚ùå Falha cr√≠tica: N√£o foi poss√≠vel criar um usu√°rio an√¥nimo. O boleto n√£o ser√° salvo.");
            return;
        }
        System.out.println("üîó Novo usu√°rio an√¥nimo criado com ID: " + usuarioAnonimo.getId());
        boleto.setUsuarioId(usuarioAnonimo.getId());

        System.out.println("\n--- Resumo e Prepara√ß√£o para Salvamento ---");
        System.out.println("Linha Digital: " + boleto.getCodigoBarras());
        System.out.println("Valor Informado pelo Usu√°rio: " + boleto.getValor());
        System.out.println("Valor Extra√≠do da Linha Digital: " + valorDoCodigoBarras);
        System.out.println("CNPJ Benefici√°rio Informado: " + boleto.getCnpjEmitente());
        System.out.println("Raz√£o Social (API): " + (boleto.getRazaoSocialApi() != null ? boleto.getRazaoSocialApi() : "N√£o dispon√≠vel"));
        System.out.println("Nome Fantasia (API): " + (boleto.getNomeFantasiaApi() != null ? boleto.getNomeFantasiaApi() : "N√£o dispon√≠vel"));
        System.out.println("C√≥digo Banco (Linha Digital): " + boleto.getBancoEmissor());
        System.out.println("Nome Banco (API): " + (boleto.getNomeBancoApi() != null ? boleto.getNomeBancoApi() : "N√£o dispon√≠vel"));
        System.out.println("Nome Completo Banco (API): " + (boleto.getNomeCompletoBancoApi() != null ? boleto.getNomeCompletoBancoApi() : "N√£o dispon√≠vel"));
        System.out.println("ISPB (API): " + (boleto.getIspbBancoApi() != null ? boleto.getIspbBancoApi() : "N√£o dispon√≠vel"));
        System.out.println("Informa√ß√µes CNPJ e Banco Confirmadas pelo Usu√°rio: " + (boleto.isInformacoesConfirmadasPeloUsuario() ? "Sim" : "N√£o"));
        System.out.println("Status de Valida√ß√£o Geral: " + boleto.getStatusValidacao());
        System.out.println("Status de Valida√ß√£o de Banco: " + boleto.getStatusValidacaoBanco());
        System.out.println("Denunciado Automaticamente: " + (boleto.isDenunciado() ? "Sim" : "N√£o"));

        System.out.println("\nüíæ Tentando salvar boleto no banco de dados...");
        try {
            if (repositorioLinhaDigitavel.inserirBoletoPorLinhaDigitavel(boleto)) {
                System.out.println("üéâ Boleto salvo no banco de dados com sucesso!");
            } else {
                System.err.println("‚ùå Falha desconhecida ao salvar o boleto.");
            }
        } catch (SQLException e) {
            System.err.println("‚ùå Erro ao salvar boleto no banco de dados: " + e.getMessage());
            e.printStackTrace();
            throw e; // Re-lan√ßa a exce√ß√£o para tratamento superior
        }

        System.out.println("\nProcessamento da linha digital conclu√≠do.");
    }

    /**
     * Insere ou atualiza um CNPJ na tabela CNPJ_Emitente.
     * Este m√©todo foi duplicado do ProcessadorBoleto para garantir a consist√™ncia
     * da base de dados antes de inserir um Boleto que faz refer√™ncia a este CNPJ.
     * @param cnpj O CNPJ a ser inserido/verificado.
     * @param nomeRazaoSocial O nome/raz√£o social associado ao CNPJ.
     * @throws SQLException Se ocorrer um erro no acesso ao banco de dados.
     */
    private void inserirOuAtualizarCnpjEmitente(String cnpj, String nomeRazaoSocial) throws SQLException {
        String checkSql = "SELECT COUNT(*) FROM CNPJ_Emitente WHERE cnpj = ?";
        String insertSql = "INSERT INTO CNPJ_Emitente (cnpj, nome_razao_social, data_abertura) VALUES (?, ?, ?)";

        try (Connection conexao = ConexaoBD.getConexao()) {
            try (PreparedStatement checkStmt = conexao.prepareStatement(checkSql)) {
                checkStmt.setString(1, cnpj);
                ResultSet rs = checkStmt.executeQuery();
                if (rs.next() && rs.getInt(1) > 0) {
                    System.out.println("‚úÖ CNPJ Emitente '" + cnpj + "' j√° existe na tabela CNPJ_Emitente.");
                    return;
                }
            }

            try (PreparedStatement insertStmt = conexao.prepareStatement(insertSql)) {
                insertStmt.setString(1, cnpj);
                insertStmt.setString(2, nomeRazaoSocial != null && !nomeRazaoSocial.isEmpty() ? nomeRazaoSocial : "Desconhecido (Linha Digital)");
                insertStmt.setDate(3, Date.valueOf(LocalDate.now())); // Usa a data atual como data de abertura

                int linhasAfetadas = insertStmt.executeUpdate();
                if (linhasAfetadas > 0) {
                    System.out.println("‚ûï CNPJ Emitente '" + cnpj + "' inserido na tabela CNPJ_Emitente.");
                } else {
                    System.err.println("‚ùå Falha ao inserir CNPJ Emitente '" + cnpj + "' na tabela CNPJ_Emitente.");
                }
            }
        }
    }
}