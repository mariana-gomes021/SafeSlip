/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package verificacao;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URI;
import java.text.Normalizer; // Para remover acentos
import java.util.regex.Pattern; // Para remover acentos
import org.json.JSONObject;
import usuario.Boleto; // Certifique-se de que Boleto est√° no pacote correto

public class ConsultaBanco {

    private String codigoBancoBoleto; // C√≥digo do banco extra√≠do do boleto
    private String nomeBancoBoleto;   // Nome do banco extra√≠do do boleto (campo 'banco_emissor')

    // Construtor que recebe o objeto Boleto
    public ConsultaBanco(Boleto boleto) {
        if (boleto != null && boleto.getCodigoBarras() != null && boleto.getCodigoBarras().length() >= 3) {
            // Os 3 primeiros d√≠gitos do c√≥digo de barras s√£o o c√≥digo do banco
            this.codigoBancoBoleto = boleto.getCodigoBarras().substring(0, 3).trim();
        } else {
            this.codigoBancoBoleto = null; // Ou lance uma exce√ß√£o, dependendo da sua regra de neg√≥cio
            System.err.println("‚ö†Ô∏è N√£o foi poss√≠vel extrair o c√≥digo do banco do boleto. C√≥digo de barras inv√°lido ou ausente.");
        }
        this.nomeBancoBoleto = (boleto.getBancoEmissor() != null) ? boleto.getBancoEmissor().trim() : null;
    }

    /**
     * Normaliza uma string de nome de banco para facilitar a compara√ß√£o.
     * Remove acentos, converte para min√∫sculas, remove termos comuns e espa√ßos extras.
     *
     * @param nome O nome do banco a ser normalizado.
     * @return O nome do banco normalizado.
     */
    private String normalizarNomeBanco(String nome) {
        if (nome == null || nome.trim().isEmpty()) {
            return "";
        }
        // Remove acentos
        String nomeNormalizado = Normalizer.normalize(nome, Normalizer.Form.NFD);
        Pattern pattern = Pattern.compile("\\p{InCombiningDiacriticalMarks}+");
        nomeNormalizado = pattern.matcher(nomeNormalizado).replaceAll("");

        nomeNormalizado = nomeNormalizado.toLowerCase()
                .replace("s.a.", "")
                .replace("s/a", "")
                .replace("ltda.", "")
                .replace("bco", "banco") // Padroniza "bco" para "banco"
                .replaceAll("[^a-z0-9\\s]", "") // Remove caracteres especiais, exceto letras, n√∫meros e espa√ßos
                .replaceAll("\\s+", " ").trim(); // Remove espa√ßos m√∫ltiplos e no in√≠cio/fim
        return nomeNormalizado;
    }

    /**
     * Consulta a API da BrasilAPI para obter dados de um banco pelo seu c√≥digo.
     *
     * @param codigoBanco O c√≥digo do banco a ser consultado (ex: "001", "237").
     * @return Um array de String contendo [codigo_banco, nome_banco,
     * nome_completo_banco, ispb] ou null em caso de erro ou banco n√£o
     * encontrado.
     */
    private String[] getDadosBancoDaApi(String codigoBanco) {
        if (codigoBanco == null || codigoBanco.trim().isEmpty()) {
            System.err.println("‚ùå C√≥digo do banco para consulta API √© nulo ou vazio.");
            return null;
        }

        String urlApi = "https://brasilapi.com.br/api/banks/v1/" + codigoBanco.trim();

        try {
            URI uri = new URI(urlApi);
            HttpURLConnection conexao = (HttpURLConnection) uri.toURL().openConnection();
            conexao.setRequestMethod("GET");
            conexao.setRequestProperty("Accept", "application/json");

            conexao.setConnectTimeout(10000); // 10 segundos para tentar conectar
            conexao.setReadTimeout(15000);    // 15 segundos para ler os dados

            int status = conexao.getResponseCode();

            if (status == 404) {
                System.err.println("‚ö†Ô∏è Banco com c√≥digo '" + codigoBanco + "' n√£o encontrado na BrasilAPI (c√≥digo HTTP 404).");
                return null;
            } else if (status != 200) {
                System.err.println("‚ùå Erro ao consultar API BrasilAPI para banco " + codigoBanco + ". C√≥digo HTTP: " + status);
                // Adicionar leitura do corpo do erro, se houver
                try (BufferedReader errorReader = new BufferedReader(new InputStreamReader(conexao.getErrorStream()))) {
                    StringBuilder erroResposta = new StringBuilder();
                    String linhaErro;
                    while ((linhaErro = errorReader.readLine()) != null) {
                        erroResposta.append(linhaErro);
                    }
                    System.err.println("   Detalhe do erro: " + erroResposta.toString());
                } catch (Exception e) {
                    // Ignorar se n√£o conseguir ler o corpo do erro
                }
                return null;
            }

            BufferedReader reader = new BufferedReader(new InputStreamReader(conexao.getInputStream()));
            StringBuilder resposta = new StringBuilder();
            String linha;

            while ((linha = reader.readLine()) != null) {
                resposta.append(linha);
            }

            reader.close();
            conexao.disconnect();

            JSONObject json = new JSONObject(resposta.toString());

            if (json.has("message") && json.getString("message").toLowerCase().contains("n√£o encontrado")) {
                System.err.println("‚ö†Ô∏è Banco com c√≥digo '" + codigoBanco + "' n√£o encontrado na BrasilAPI (mensagem no corpo).");
                return null;
            }

            // A API retorna o c√≥digo como string para alguns bancos e int para outros.
            // Vamos garantir que seja sempre uma string.
            String code = null;
            if (json.has("code")) {
                Object codeObj = json.get("code");
                if (codeObj instanceof Number) {
                    // Formata para ter 3 d√≠gitos, preenchendo com zeros √† esquerda se necess√°rio
                    code = String.format("%03d", ((Number) codeObj).intValue());
                } else if (codeObj instanceof String) {
                    code = (String) codeObj;
                } else if (codeObj != JSONObject.NULL){
                     code = String.valueOf(codeObj);
                }
            }

            String name = json.optString("name", null);
            String fullName = json.optString("fullName", null);
            String ispb = json.optString("ispb", null);

            System.out.println("‚úÖ Dados da API para Banco " + codigoBanco + ":");
            System.out.println("   C√≥digo do Banco (API): " + (code != null ? code : "N√£o dispon√≠vel"));
            System.out.println("   Nome do Banco (API): " + (name != null ? name : "N√£o dispon√≠vel"));
            System.out.println("   Nome Completo do Banco (API): " + (fullName != null ? fullName : "N√£o dispon√≠vel"));
            System.out.println("   ISPB: " + (ispb != null ? ispb : "N√£o dispon√≠vel"));

            return new String[]{code, name, fullName, ispb};

        } catch (java.net.SocketTimeoutException e) {
            System.err.println("‚ùå Timeout ao conectar/ler da API BrasilAPI para banco " + codigoBanco + ": " + e.getMessage());
            return null;
        }
         catch (org.json.JSONException e) {
            System.err.println("‚ùå Erro ao processar JSON da API para banco " + codigoBanco + ": " + e.getMessage());
            return null;
        }
        catch (Exception e) {
            System.err.println("‚ùå Erro inesperado durante a consulta ou processamento da API para banco " + codigoBanco + ": " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }

    /**
     * Valida o c√≥digo e nome do banco do boleto comparando com os dados da
     * BrasilAPI.
     *
     * @return Uma String indicando o status da valida√ß√£o ('VALIDO', 'INVALIDO_CODIGO',
     * 'INVALIDO_NOME', 'ERRO_API', 'NAO_VALIDADO')
     */
    public String validarBancoComApi() {
        if (this.codigoBancoBoleto == null || this.codigoBancoBoleto.isEmpty()) {
            System.err.println("‚ùå C√≥digo do banco do boleto n√£o encontrado. N√£o √© poss√≠vel validar com a API.");
            return "NAO_VALIDADO"; // N√£o h√° c√≥digo para validar
        }

        String[] dadosApi = getDadosBancoDaApi(this.codigoBancoBoleto);

        if (dadosApi == null) {
            System.err.println("‚ùå N√£o foi poss√≠vel obter dados do banco da API para valida√ß√£o.");
            return "ERRO_API";
        }

        String codigoApi = dadosApi[0];
        String nomeApi = dadosApi[1];
        String fullNameApi = dadosApi[2];

        // 1. Valida√ß√£o do C√≥digo do Banco
        // A API pode retornar o c√≥digo como n√∫mero, ent√£o formatamos para string com 3 d√≠gitos.
        // O c√≥digo do boleto j√° √© string.
        if (codigoApi == null || !this.codigoBancoBoleto.equals(codigoApi)) {
            System.out.println("üö´ C√≥digo do banco do boleto ('" + this.codigoBancoBoleto + "') n√£o bate com o da API ('" + (codigoApi != null ? codigoApi : "N/A") + "').");
            return "INVALIDO_CODIGO";
        }
        System.out.println("‚úÖ C√≥digo do Banco ('" + this.codigoBancoBoleto + "') bate com o da API.");

        // 2. Valida√ß√£o do Nome do Banco (se dispon√≠vel no boleto)
        if (this.nomeBancoBoleto == null || this.nomeBancoBoleto.isEmpty()) {
            System.out.println("‚ÑπÔ∏è Nome do banco n√£o extra√≠do do boleto. Valida√ß√£o do nome pulada. Banco considerado V√ÅLIDO pelo c√≥digo.");
            return "VALIDO"; // V√°lido pelo c√≥digo, nome n√£o dispon√≠vel para checagem.
        }

        String nomeBoletoNormalizado = normalizarNomeBanco(this.nomeBancoBoleto);
        String nomeApiNormalizado = normalizarNomeBanco(nomeApi);
        String fullNameApiNormalizado = normalizarNomeBanco(fullNameApi);

        System.out.println("   Nome Boleto (Original): '" + this.nomeBancoBoleto + "' -> Normalizado: '" + nomeBoletoNormalizado + "'");
        System.out.println("   Nome API (Curto): '" + (nomeApi != null ? nomeApi : "N/A") + "' -> Normalizado: '" + nomeApiNormalizado + "'");
        System.out.println("   Nome API (Completo): '" + (fullNameApi != null ? fullNameApi : "N/A") + "' -> Normalizado: '" + fullNameApiNormalizado + "'");

        // Tenta a correspond√™ncia com o nome curto ou nome completo da API
        boolean nomeCorresponde = false;
        if (!nomeApiNormalizado.isEmpty() && nomeBoletoNormalizado.contains(nomeApiNormalizado)) {
            nomeCorresponde = true;
        } else if (!fullNameApiNormalizado.isEmpty() && nomeBoletoNormalizado.contains(fullNameApiNormalizado)) {
            nomeCorresponde = true;
        }
        // Verifica√ß√£o adicional: se o nome da API (mais curto) est√° contido no nome do boleto
         else if (!nomeApiNormalizado.isEmpty() && !nomeBoletoNormalizado.isEmpty() && nomeApiNormalizado.contains(nomeBoletoNormalizado) ) {
            nomeCorresponde = true;
        }


        if (!nomeCorresponde) {
            System.out.println("üö´ Nome do banco do boleto (Normalizado: '" + nomeBoletoNormalizado +
                               "') n√£o corresponde aos nomes da API (Normalizados: '" + nomeApiNormalizado +
                               "' / '" + fullNameApiNormalizado + "').");
            return "INVALIDO_NOME";
        }

        System.out.println("‚úÖ **Nome do Banco bate com os dados da API (ap√≥s normaliza√ß√£o)!**");
        return "VALIDO";
    }
}
